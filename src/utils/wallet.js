import dotenv from "dotenv";
dotenv.config();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âœ… Handle TronWeb import (CJS + ESM safe)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import * as TronWebPkg from "tronweb";
const TronWeb = TronWebPkg.TronWeb || TronWebPkg.default || TronWebPkg;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“š HD Wallet dependencies
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
import { mnemonicToSeedSync, validateMnemonic } from "@scure/bip39";
import { wordlist } from "@scure/bip39/wordlists/english.js";
import { HDKey } from "@scure/bip32";
import { logger } from "./logger.js";

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// âš™ï¸ Network setup
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const NETWORK = (process.env.NETWORK || "mainnet").toLowerCase();
const IS_SHASTA = NETWORK === "shasta";

export const tronWeb = new TronWeb({
  fullHost: IS_SHASTA ? "https://api.shasta.trongrid.io" : "https://api.trongrid.io",
  headers: process.env.TRONGRID_API_KEY
    ? { "TRON-PRO-API-KEY": process.env.TRONGRID_API_KEY }
    : undefined,
  privateKey: process.env.TRON_PRIVATE_KEY || undefined,
});

logger.info(`ğŸŒ Tron network initialized â†’ ${IS_SHASTA ? "Shasta Testnet" : "Mainnet"}`);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ§  Validate master mnemonic
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let MASTER_MNEMONIC = (process.env.MASTER_MNEMONIC || "")
  .replace(/^["']+|["']+$/g, "")
  .replace(/\s+/g, " ")
  .trim();

if (!MASTER_MNEMONIC) throw new Error("âŒ MASTER_MNEMONIC missing in .env");

if (!validateMnemonic(MASTER_MNEMONIC, wordlist)) {
  throw new Error("âŒ Invalid MASTER_MNEMONIC â€” checksum failed");
}
logger.info("âœ… Master mnemonic validated successfully.");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ” Derive TRON HD wallet (BIP-44: m/44'/195'/0'/0/index)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export function deriveAddressForIndex(index) {
  if (!Number.isInteger(index) || index < 0)
    throw new Error(`âŒ Invalid derivation index: ${index}`);

  // 1ï¸âƒ£ Generate master seed
  const seed = mnemonicToSeedSync(MASTER_MNEMONIC);

  // 2ï¸âƒ£ Derive path for TRON (195)
  const root = HDKey.fromMasterSeed(seed);
  const path = `m/44'/195'/0'/0/${index}`;
  const child = root.derive(path);

  if (!child.privateKey) throw new Error(`âŒ No private key derived at index ${index}`);

  // 3ï¸âƒ£ Convert to hex & get TRON address
  const privHex = Buffer.from(child.privateKey).toString("hex");
  const pubAddr = tronWeb.utils.crypto.getBase58CheckAddress(
    tronWeb.utils.crypto.computeAddress(privHex)
  );

  logger.debug(`ğŸ§© Derived TRON address ${pubAddr} (path: ${path})`);
  return { index, address: pubAddr, privHex, path };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ‘¤ Deterministic deposit address per Telegram user
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export function getAddressForUser(telegramId) {
  if (!telegramId) throw new Error("telegramId required");

  // Telegram IDs are large integers; reduce deterministically but safely
  const numericIndex = Math.abs(Number(String(telegramId).replace(/\D/g, ""))) % 1_000_000;

  const { address } = deriveAddressForIndex(numericIndex);

  logger.info(`ğŸ¯ Derived deterministic TRON deposit address for ${telegramId}: ${address}`);
  return address;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ§± Export both the instance and derivation methods
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
export default {
  tronWeb,
  deriveAddressForIndex,
  getAddressForUser,
};
